// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Lead {
  id          String   @id @default(cuid())
  nombre      String
  dni         String?  @unique
  cuil        String?
  telefono    String
  email       String?
  ingresos    Int?
  zona        String?
  producto    String?
  monto       Int?
  origen      String?
  utmSource   String?
  estado      String   @default("NUEVO")
  agencia     String?
  banco       String?
  trabajo_actual String?
  notas       String?
  whatsappId   String?  @unique
  tags         String?
  customFields String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  events        Event[]
  conversations Conversation[]
  syncLogs      WhatsAppSync[]

  @@index([telefono])
  @@index([estado])
  @@index([createdAt])
  @@index([origen])
  @@index([whatsappId])
}

model Event {
  id        String   @id @default(cuid())
  leadId    String?
  tipo      String
  payload   String?
  createdAt DateTime @default(now())
  lead      Lead?    @relation(fields: [leadId], references: [id])

  @@index([leadId])
  @@index([tipo])
  @@index([createdAt])
}

model User {
  id        String   @id @default(cuid())
  nombre    String
  email     String   @unique
  hash      String
  rol       String   @default("VENDEDOR")
  createdAt DateTime @default(now())
  
  assignedConversations Conversation[]
  createdAssistants     Assistant[]
}

model Assistant {
  id            String   @id @default(cuid())
  nombre        String
  descripcion   String?
  instrucciones String   @db.Text
  isDefault     Boolean  @default(false)
  isActive      Boolean  @default(true)
  createdBy     String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  creator       User     @relation(fields: [createdBy], references: [id])
  
  @@index([createdBy])
  @@index([isActive])
  @@index([isDefault])
}

model Rule {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Conversation {
  id            String   @id @default(cuid())
  leadId        String?
  platform      String
  platformId    String
  status        String   @default("open")
  assignedTo    String?
  lastMessageAt DateTime @default(now())
  whatsappData  String?
  phoneNumberId String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  lead          Lead?    @relation(fields: [leadId], references: [id])
  messages      Message[]
  assignedUser  User?    @relation(fields: [assignedTo], references: [id])
  
  @@unique([platform, platformId])
  @@index([status])
  @@index([assignedTo])
  @@index([lastMessageAt])
}

model Message {
  id             String   @id @default(cuid())
  conversationId String
  direction      String
  content        String
  mediaUrl       String?
  messageType    String   @default("text")
  platformMsgId  String?  @unique
  sentAt         DateTime @default(now())
  readAt         DateTime?
  deliveredAt    DateTime?
  
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  
  @@index([conversationId])
  @@index([sentAt])
}

model WhatsAppSync {
  id          String   @id @default(cuid())
  leadId      String
  syncType    String
  status      String   @default("pending")
  direction   String
  data        String?
  error       String?
  retryCount  Int      @default(0)
  createdAt   DateTime @default(now())
  completedAt DateTime?
  
  lead        Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  
  @@index([leadId])
  @@index([status])
  @@index([syncType])
  @@index([createdAt])
}

model WhatsAppTemplate {
  id          String   @id @default(cuid())
  name        String   @unique
  category    String
  language    String   @default("es")
  content     String   @db.Text
  status      String   @default("pending")
  metaId      String?  @unique
  approvedAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([status])
  @@index([category])
  @@index([language])
}

